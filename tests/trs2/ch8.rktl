(displayln "Test code in chapter 8")
(: *o       (→ Term Term Term Goal))
(: odd-*o   (→ Term Term Term Term Goal))
(: bound-*o (→ Term Term Term Term Goal))
(define (*o n m p)
  (condi
    [(== '() n) (== '() p)]
    [(poso n) (== '() m) (== '() p)]
    [(== '(1) n) (poso m) (== m p)]
    [(>1o n) (== '(1) m) (== n p)]
    [(fresh (x z)
       (== `(0 . ,x) n) (poso x)
       (== `(0 . ,z) p) (poso z)
       (>1o m)
       (*o x m z))]
    [(fresh (x y)
       (== `(1 . ,x) n) (poso x)
       (== `(0 . ,y) m) (poso y)
       (*o m n p))]
    [(fresh (x y)
       (== `(1 . ,x) n) (poso x)
       (== `(1 . ,y) m) (poso y)
       (odd-*o x n m p))]
    [else fail]))
(define (odd-*o x n m p)
  (fresh (q)
    (bound-*o q p n m)
    (*o x m q)
    (+o `(0 . ,q) m p)))
(define (bound-*o q p n m)
  (conde
    [(nullo q) (pairo p)]
    [else
     (fresh (x y z)
       (cdro q x)
       (cdro p y)
       (condi
         [(nullo n)
          (cdro m z)
          (bound-*o x y z '())]
         [else
          (cdro n z)
          (bound-*o x y z m)]))]))
(check-equal?
 (run 34 (t)
   (fresh (x y r)
     (*o x y r)
     (== `(,x ,y ,r) t)))
 '((() _.0 ())
   ((_.0 . _.1) () ())
   ((1) (_.0 . _.1) (_.0 . _.1))
   ((_.0 _.1 . _.2) (1) (_.0 _.1 . _.2))
   ((0 1) (_.0 _.1 . _.2) (0 _.0 _.1 . _.2))
   ((1 _.0 . _.1) (0 1) (0 1 _.0 . _.1))
   ((0 0 1) (_.0 _.1 . _.2) (0 0 _.0 _.1 . _.2))
   ((1 1) (1 1) (1 0 0 1))
   ((0 1 _.0 . _.1) (0 1) (0 0 1 _.0 . _.1))
   ((1 _.0 . _.1) (0 0 1) (0 0 1 _.0 . _.1))
   ((0 0 0 1) (_.0 _.1 . _.2) (0 0 0 _.0 _.1 . _.2))
   ((1 1) (1 0 1) (1 1 1 1))
   ((0 1 1) (1 1) (0 1 0 0 1))
   ((1 1) (0 1 1) (0 1 0 0 1))
   ((0 0 1 _.0 . _.1) (0 1) (0 0 0 1 _.0 . _.1))
   ((1 1) (1 1 1) (1 0 1 0 1))
   ((0 1 _.0 . _.1) (0 0 1) (0 0 0 1 _.0 . _.1))
   ((1 _.0 . _.1) (0 0 0 1) (0 0 0 1 _.0 . _.1))
   ((0 0 0 0 1) (_.0 _.1 . _.2) (0 0 0 0 _.0 _.1 . _.2))
   ((1 0 1) (1 1) (1 1 1 1))
   ((0 1 1) (1 0 1) (0 1 1 1 1))
   ((1 0 1) (0 1 1) (0 1 1 1 1))
   ((0 0 1 1) (1 1) (0 0 1 0 0 1))
   ((1 1) (1 0 0 1) (1 1 0 1 1))
   ((0 1 1) (0 1 1) (0 0 1 0 0 1))
   ((1 1) (0 0 1 1) (0 0 1 0 0 1))
   ((0 0 0 1 _.0 . _.1) (0 1) (0 0 0 0 1 _.0 . _.1))
   ((1 1) (1 1 0 1) (1 0 0 0 0 1))
   ((0 1 1) (1 1 1) (0 1 0 1 0 1))
   ((1 1 1) (0 1 1) (0 1 0 1 0 1))
   ((0 0 1 _.0 . _.1) (0 0 1) (0 0 0 0 1 _.0 . _.1))
   ((1 1) (1 0 1 1) (1 1 1 0 0 1))
   ((0 1 _.0 . _.1) (0 0 0 1) (0 0 0 0 1 _.0 . _.1))
   ((1 _.0 . _.1) (0 0 0 0 1) (0 0 0 0 1 _.0 . _.1))))
(check-equal?
 (run* (p)
   (*o '(0 1) '(0 0 1) p))
 '((0 0 0 1)))
(check-equal?
 (run 1 (t)
   (fresh (n m)
     (*o n m '(1))
     (== `(,n ,m) t)))
 '(((1) (1))))
(check-equal?
 (run 2 (t)
   (fresh (n m)
     (*o n m '(1))
     (== `(,n ,m) t)))
 '(((1) (1))))
(check-equal?
 (run* (p)
   (*o '(1 1 1) '(1 1 1 1 1 1) p))
 '((1 0 0 1 1 1 0 1 1)))

(: =lo (→ Term Term Goal))
(define (=lo n m)
  (conde
    [(== '() n) (== '() m)]
    [(== '(1) n) (== '(1) m)]
    [else
     (fresh (a x b y)
       (== `(,a . ,x) n) (poso x)
       (== `(,b . ,y) m) (poso y)
       (=lo x y))]))
(check-equal?
 (run* (t)
   (fresh (w x y)
     (=lo `(1 ,w ,x . ,y) '(0 1 1 0 1))
     (== `(,w ,x ,y) t)))
 '((_.0 _.1 (_.2 1))))
(check-equal?
 (run* (b)
   (=lo '(1) `(,b)))
 '(1))
(check-equal?
 (run* (n)
   (=lo `(1 0 1 . ,n) '(0 1 1 0 1)))
 '((_.0 1)))
(check-equal?
 (run 5 (t)
   (fresh (y z)
     (=lo `(1 . ,y) `(1 . ,z))
     (== `(,y ,z) t)))
 '((() ())
   ((1) (1))
   ((_.0 1) (_.1 1))
   ((_.0 _.1 1) (_.2 _.3 1))
   ((_.0 _.1 _.2 1) (_.3 _.4 _.5 1))))
(check-equal?
 (run 5 (t)
   (fresh (y z)
     (=lo `(1 . ,y) `(0 . ,z))
     (== `(,y ,z) t)))
 '(((1) (1))
   ((_.0 1) (_.1 1))
   ((_.0 _.1 1) (_.2 _.3 1))
   ((_.0 _.1 _.2 1) (_.3 _.4 _.5 1))
   ((_.0 _.1 _.2 _.3 1) (_.4 _.5 _.6 _.7 1))))
(check-equal?
 (run 5 (t)
   (fresh (y z)
     (=lo `(1 . ,y) `(0 1 1 0 1 . ,z))
     (== `(,y ,z) t)))
 '(((_.0 _.1 _.2 1) ())
   ((_.0 _.1 _.2 _.3 1) (1))
   ((_.0 _.1 _.2 _.3 _.4 1) (_.5 1))
   ((_.0 _.1 _.2 _.3 _.4 _.5 1) (_.6 _.7 1))
   ((_.0 _.1 _.2 _.3 _.4 _.5 _.6 1) (_.7 _.8 _.9 1))))

(: <lo (→ Term Term Goal))
(define (<lo n m)
  (conde
    [(== '() n) (poso m)]
    [(== '(1) n) (>1o m)]
    [else
     (fresh (a x b y)
       (== `(,a . ,x) n) (poso x)
       (== `(,b . ,y) m) (poso y)
       (<lo x y))]))
(check-equal?
 (run 8 (t)
   (fresh (y z)
     (<lo `(1 . ,y) `(0 1 1 0 1 . ,z))
     (== `(,y ,z) t)))
 '((() _.0)
   ((1) _.0)
   ((_.0 1) _.1)
   ((_.0 _.1 1) _.2)
   ((_.0 _.1 _.2 1) (_.3 . _.4))
   ((_.0 _.1 _.2 _.3 1) (_.4 _.5 . _.6))
   ((_.0 _.1 _.2 _.3 _.4 1) (_.5 _.6 _.7 . _.8))
   ((_.0 _.1 _.2 _.3 _.4 _.5 1) (_.6 _.7 _.8 _.9 . _.10))))

(: <=lo (→ Term Term Goal))
(define (<=lo n m)
  (condi
    [(=lo n m) succeed]
    [(<lo n m) succeed]
    [else fail]))
(check-equal?
 (run 10 (t)
   (fresh (n m)
     (<=lo n m)
     (*o n '(0 1) m)
     (== `(,n ,m) t)))
 '((() ())
   ((1) (0 1))
   ((0 1) (0 0 1))
   ((1 1) (0 1 1))
   ((0 0 1) (0 0 0 1))
   ((1 _.0 1) (0 1 _.0 1))
   ((0 1 1) (0 0 1 1))
   ((0 0 0 1) (0 0 0 0 1))
   ((1 _.0 _.1 1) (0 1 _.0 _.1 1))
   ((0 1 _.0 1) (0 0 1 _.0 1))))
(check-equal?
 (run 15 (t)
   (fresh (n m)
     (<=lo n m)
     (== `(,n ,m) t)))
 '((() ())
   (() (_.0 . _.1))
   ((1) (1))
   ((1) (_.0 _.1 . _.2))
   ((_.0 1) (_.1 1))
   ((_.0 1) (_.1 _.2 _.3 . _.4))
   ((_.0 _.1 1) (_.2 _.3 1))
   ((_.0 _.1 1) (_.2 _.3 _.4 _.5 . _.6))
   ((_.0 _.1 _.2 1) (_.3 _.4 _.5 1))
   ((_.0 _.1 _.2 1) (_.3 _.4 _.5 _.6 _.7 . _.8))
   ((_.0 _.1 _.2 _.3 1) (_.4 _.5 _.6 _.7 1))
   ((_.0 _.1 _.2 _.3 1) (_.4 _.5 _.6 _.7 _.8 _.9 . _.10))
   ((_.0 _.1 _.2 _.3 _.4 1) (_.5 _.6 _.7 _.8 _.9 1))
   ((_.0 _.1 _.2 _.3 _.4 1) (_.5 _.6 _.7 _.8 _.9 _.10 _.11 . _.12))
   ((_.0 _.1 _.2 _.3 _.4 _.5 1) (_.6 _.7 _.8 _.9 _.10 _.11 1))))

(: <o (→ Term Term Goal))
(define (<o n m)
  (condi
    [(<lo n m) succeed]
    [(=lo n m)
     (fresh (x)
       (poso x)
       (+o n x m))]
    [else fail]))
(: <=o (→ Term Term Goal))
(define (<=o n m)
  (condi
    [(== n m) succeed]
    [(<o n m) succeed]
    [else fail]))
(check-equal?
 (run* (q)
   (<o '(1 0 1) '(1 1 1))
   (== #t q))
 '(#t))
(check-equal?
 (run* (q)
   (<o '(1 1 1) '(1 0 1))
   (== #t q))
 '())
(check-equal?
 (run* (q)
   (<o '(1 0 1) '(1 0 1))
   (== #t q))
 '())
(check-equal?
 (run 6 (n)
   (<o n '(1 0 1)))
 '(() (0 0 1) (1) (_.0 1)))
(check-equal?
 (run 6 (m)
   (<o '(1 0 1) m))
 '((_.0 _.1 _.2 _.3 . _.4) (0 1 1) (1 1 1)))

(: splito (→ Term Term Term Term Goal))
(define (splito n r l h)
  (condi
    [(== '() n) (== '() h) (== '() l)]
    [(fresh (b n^)
       (== `(0 ,b . ,n^) n)
       (== '() r)
       (== `(,b . ,n^) h)
       (== '() l))]
    [(fresh (n^)
       (== `(1 . ,n^) n)
       (== '() r)
       (== n^ h)
       (== '(1) l))]
    [(fresh (b n^ a r^)
       (== `(0 ,b . ,n^) n)
       (== `(,a . ,r^) r)
       (== '() l)
       (splito `(,b . ,n^) r^ '() h))]
    [(fresh (n^ a r^)
       (== `(1 . ,n^) n)
       (== `(,a . ,r^) r)
       (== '(1) l)
       (splito n^ r^ '() h))]
    [(fresh (b n^ a r^ l^)
       (== `(,b . ,n^) n)
       (== `(,a . ,r^) r)
       (== `(,b . ,l^) l)
       (poso l^)
       (splito n^ r^ l^ h))]
    [else fail]))
(: ÷o (→ Term Term Term Term Goal))
(define (÷o n m q r)
  (condi
    [(== r n) (== '() q) (<o n m)]
    [(== '(1) q) (=lo n m) (+o r m n)
     (<o r m)]
    [else
     (alli
       (<lo m n)
       (<o r m)
       (poso q)
       (fresh (nh nl qh ql qlm qlmr rr rh)
         (alli
           (splito n r nl nh)
           (splito q r ql qh)
           (conde
             [(== '() nh)
              (== '() qh)
              (-o nl r qlm)
              (*o ql m qlm)]
             [else
              (alli
                (poso nh)
                (*o ql m qlm)
                (+o qlm r qlmr)
                (-o qlmr nl rr)
                (splito rr r '() rh)
                (÷o nh m qh rh))]))))]))
(check-equal?
 (run 15 (t)
   (fresh (n m q r)
     (÷o n m q r)
     (== `(,n ,m ,q ,r) t)))
 '((() (_.0 . _.1) () ())
   ((1) (1) (1) ())
   ((0 1) (1 1) () (0 1))
   ((0 1) (1) (0 1) ())
   ((1) (_.0 _.1 . _.2) () (1))
   ((_.0 1) (_.0 1) (1) ())
   ((0 _.0 1) (1 _.0 1) () (0 _.0 1))
   ((0 _.0 1) (_.0 1) (0 1) ())
   ((_.0 1) (_.1 _.2 _.3 . _.4) () (_.0 1))
   ((1 1) (0 1) (1) (1))
   ((0 0 1) (0 1 1) () (0 0 1))
   ((1 1) (1) (1 1) ())
   ((_.0 _.1 1) (_.2 _.3 _.4 _.5 . _.6) () (_.0 _.1 1))
   ((_.0 _.1 1) (_.0 _.1 1) (1) ())
   ((1 0 1) (0 1 1) () (1 0 1))))
